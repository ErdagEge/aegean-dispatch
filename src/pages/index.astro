---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import { readingTime } from '../utils/readingTime';

const base = (import.meta.env.BASE_URL ?? '/').replace(/\/?$/, '/');
const withBase = (path: string) => (path?.startsWith('/') ? `${base}${path.slice(1)}` : path);

const posts = (await getCollection('posts'))
  .map((post) => ({ ...post, readingTime: readingTime(post.body) }))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 4);
---

<BaseLayout>
  <section class="hero">
    <p class="pill">Aegean Dispatch</p>
    <h1>Quiet notes from the shoreline</h1>
    <p>
      Essays and dispatches on cinema, technology, books, and movement. A minimal, distraction-free
      blog built with Astro.
    </p>
    <div class="hero-actions">
      <a class="button" href={withBase('/posts')}>Browse all posts</a>
      <a class="button secondary" href={withBase('/about')}>About the author</a>
    </div>
  </section>

  <section>
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.8rem;">
      <div>
        <h2 class="heading" style="margin: 0;">Recent posts</h2>
        <p class="subheading" style="margin: 0;">Latest writing across the Aegean Dispatch.</p>
      </div>
      <a href={withBase('/posts')} class="button secondary" style="padding: 0.55rem 0.85rem;">View all</a>
    </div>
    <div class="grid">
      {posts.map((post) => (
        <article class="card">
          <div class="post-meta" style="margin-bottom: 0.6rem;">
        <span>{post.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
        <span aria-hidden="true">â€¢</span>
        <span>{post.readingTime} min read</span>
        {post.data.tags.slice(0, 2).map((tag) => (
          <a class="pill pill-link" href={withBase(`/tags/${tag.toLowerCase()}/`)}>{tag}</a>
        ))}
          </div>
          {post.data.cover && (
            typeof post.data.cover === 'string' ? (
              <img class="card-thumb" src={withBase(post.data.cover)} alt={post.data.coverAlt ?? ''} loading="lazy" />
            ) : (
              <Image class="card-thumb" src={post.data.cover} alt={post.data.coverAlt ?? ''} loading="lazy" />
            )
          )}
          <h3 class="post-title" style="margin-bottom: 0.35rem;">
            <a class="card-link" href={withBase(`/posts/${post.slug}/`)}>{post.data.title}</a>
          </h3>
          {post.data.description && <p class="text-muted" style="margin: 0;">{post.data.description}</p>}
        </article>
      ))}
    </div>
  </section>
</BaseLayout>
